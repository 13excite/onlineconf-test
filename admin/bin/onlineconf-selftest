#!/usr/bin/perl

use strict;
use warnings;
use Getopt::Long;
use File::Spec::Unix;
use Log::Dispatch;
use POSIX qw/strftime/;
use YAML;
use MR::OnlineConf::Admin::Storage;
use MR::OnlineConf::Admin::Parameter;
use MR::ChangeBot::Database;

my %options = (
    config   => '/usr/local/etc/onlineconf.yaml',
    interval => 5,
);

GetOptions(\%options, qw/
    config|c=s
    loglevel|l=s
/);

my $config = YAML::LoadFile($options{config});

my $PATH = '/onlineconf/selftest/update-time';
my $USERNAME = 'onlineconf';

my $log = Log::Dispatch->new(
    outputs => [[ 'Screen', min_level => $options{loglevel} || $config->{loglevel} || 'info', newline => 1 ]],
    callbacks => sub {
        my %in = @_;
        my $prefix = sprintf "%s [%d] %s: ", strftime("%F %T", localtime()), $$, $in{level};
        my $message = $in{message};
        $message =~ s/^/$prefix/gm;
        $message =~ s/\n$//;
        return $message;
    },
);

MR::OnlineConf::Admin::Storage->new(%{$config->{database}}, log => $log);
MR::ChangeBot::Database->new(%{$config->{notification_database}}, log => $log);

my $test = MR::OnlineConf::Admin::Parameter->new($PATH, $USERNAME);
$test->data(time());
$test->update();
